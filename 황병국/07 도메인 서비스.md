## 실제 결제 금액을 계산하는 주체는?

- **주문 애그리거트 vs 결제 금액 계산**
    - 총 주문 금액 계산은 주문 애그리거트가 할 수 있다.
    - 하지만 실제 결제 금액은 단순히 총액만으로는 계산할 수 없다.
    - 총액에서 할인 금액을 빼야 한다.
    - 할인 금액은 누가 계산해야 할까?

---

## 할인 쿠폰 애그리거트의 한계

- 할인 쿠폰은 자체 할인 규칙을 가질 수 있다.
- 두 개 이상의 할인 쿠폰이 적용될 경우, 단일 할인 쿠폰 애그리거트만으로는 총 할인 금액을 계산할 수 없다.

---

## 주문 애그리거트의 책임인가?

**예시:**  
특별 감사 세일로 한 달간 전 품목 2% 추가 할인

- 이 정책은 주문 애그리거트의 구성요소와 직접적인 연관이 없다.
- 그럼에도 결제 금액 계산 책임이 주문 애그리거트에 있다면, 정책 변화 시 주문 애그리거트를 수정해야 한다.

### ⚠ 문제점

- 한 애그리거트에 넣기 애매한 도메인 기능을 억지로 구현 → 책임 범위 초과
- 코드 길어짐, 외부 의존 증가, 복잡성 상승, 수정 난이도 증가
- 애그리거트 범위를 넘어서는 도메인 개념이 숨겨져 명시적으로 드러나지 않음

---

## 해결 방법: 도메인 서비스

- 도메인 서비스는 도메인 영역에 위치하며, 도메인 로직을 표현할 때 사용한다.

### 도메인 서비스를 쓰는 경우

- **계산 로직**
    - 여러 애그리거트를 필요로 하거나, 한 애그리거트에 넣기엔 복잡한 경우
- **외부 시스템 연동 로직**
    - 타 시스템을 사용해야 하는 도메인 로직

---

## 예시: 할인 금액 계산 서비스

```java
public class DiscountCalculationService {

    public Money calculateDiscountAmounts(
        List<OrderLine> orderLines,
        List<Coupon> coupons,
        MemberGrade grade
    ) {
        // ...
    }
}
```

- **할인 계산 서비스를 사용하는 주체**
    - 애그리거트
    - 응용 서비스
    - 애그리거트에 도메인 서비스를 전달하는 것은 응용 서비스의 책임

---

## 서비스 호출 방향

- 애그리거트 메서드 실행 시 도메인 서비스를 인자로 전달
- 또는 도메인 서비스 기능을 실행할 때 애그리거트를 전달

---

## 도메인 서비스 vs 응용 서비스 구분 팁 💡

- 해당 로직이 **애그리거트 상태를 변경하거나 상태 값을 계산**한다면 → 도메인 서비스
- 단순히 **흐름 제어나 외부 호출을 관리**한다면 → 응용 서비스

---

## 외부 연동도 도메인 서비스가 될 수 있음

- 시스템 간 연동이 HTTP API 호출로 이루어지더라도, 도메인 관점에서는 도메인 로직일 수 있다.
    - 예시: 설문 조사 도메인에서 사용자의 설문 생성 권한 확인

---

## 도메인 서비스 구현의 유연성

- 로직이 고정되어 있지 않다면 **인터페이스 + 구현 클래스** 구조로 설계
    - 외부 시스템/별도 엔진 사용 시
    - 도메인 영역: 인터페이스
    - 인프라스트럭처 영역: 구현체
    - 예시: 할인 계산 로직을 룰 엔진으로 구현

---