# 📘 『도메인 주도 개발 시작하기』 - Chapter 4~6 요약 및 정리

도메인 주도 설계(DDD)를 학습하면서 정리한 내용입니다.

개념 위주 요약보다는, 실무에서 느낀 점과 함께 정리했습니다.

---

## 📑 목차

<!-- TOC -->

* [Chapter 4. 리포지터리와 모델 구현](#chapter-4-리포지터리와-모델-구현)
* [Chapter 5. 스프링 데이터 JPA를 이용한 조회 기능](#chapter-5-스프링-데이터-jpa를-이용한-조회-기능)
* [Chapter 6. 응용 서비스와 표현 영역](#chapter-6-응용-서비스와-표현-영역)
* [📌 정리 및 느낀 점](#-정리-및-느낀-점)

<!-- TOC -->
---

## Chapter 4. 리포지터리와 모델 구현

### 💬 간단 정리

- JPA를 통해 도메인 모델와 리포지터리를 구현하는 방법에 대한 챕터이다.
- JPA에서는 기본적으로 entityManager 또는 스프링 데이터 JPA를 통해 리포지터리를 구현한다.
- DDD에서 제시하는 애그리거트와 밸류를 `@Entity`와 (`@Embeddable`, `@Embedded`)로 설정할 수 있다.
    - 엔티티의 필드들을 값객체로 정의하고 `AttributeConverter`를 통해 매핑을 할 수 있다.
    - 한 엔티티가 여러 밸류를 가지는 구조라면 해당 밸류를 별도의 테이블로 분리하여 매핑할 수 있다.(`@ElementCollection`,
      `@CollectionTable`)
    - 코드 영역에서는 컬렉션의 형태인데, DB에서는 하나의 컬럼으로 매핑하는 것도 가능하다.
        - `,` 로 join 하는 등 `AttributeConverter` 를 통해 매핑할 수 있다.
    - 이외에도 여러 기술적인 구현 및 팀 내의 사정에 따라 애그리거트와 밸류를 매핑하는 전략이 다양하다.
        - *‘밸류를 이용한 ID 매핑’*
        - *‘별도 테이블에 저장하는 밸류 매핑’*
        - *‘밸류 컬렉션을 @Entity로 매핑하기’*
        - *‘ID 참조와 조인 테이블을 이용한 단방향 M-N 매핑’*
- 애그리거트 루트 안에 속해 있는 모든 객체가 원칙상으로는 한번에 조회되어야 하지만(`FetchType.EAGER`), 성능적으로 생각해서 Lazy Loading을 하는 방식도
  고려할 수 있다.(`FetchType.LAZY`)
- 애그리거트 루트에 속한 객체는 애그리거트와 생애주기가 일치해야 한다. 이는 `CascadeType`으로 설정할 수 있다.
- JPA를 도메인 모델로 바로 사용하는 것은 특정 기술에 의존적일 수 있다. 하지만, 책의 글쓴이의 경우는 개발 편의성과 실용성을 생각해서 JPA 엔티티를 도메인 모델로 주로
  사용한다.

### 💡 관련 생각

- 필드들을 값 객체로 포장하여 사용하는 것은 좋다고 생각하지만, 나머지의 기술들은 자칫 JPA에 지나치게 의존적이게 된다고 생각이 들었다.
    - 이를 팀에서 사용하기 위해 팀원 모두 JPA 및 하이버네이트의 깊은 이해가 필요할 것 같은데, 이를 달성하기 힘든 것이 아닌가 생각이 든다.
- 애그리거트의 모든 객체를 한번에 조회하는 것은 정교한 객체 설계가 필요하다고 느꼈다. 아직 애그리거트의 경계가 제대로 학습되지 않아 모든걸 EAGER 로딩하는 것은 당분간은
  위험하다는 생각이 든다.

---

## Chapter 5. 스프링 데이터 JPA를 이용한 조회 기능

### 💬 간단 정리

- 이 챕터에서는 스프링 데이터 JPA로 조회 기능을 어떻게 구현할 수 있는지 설명한다.
- 스펙(`Specification`)을 통해 리포지터리 메서드를 여러 개 만들지 않고 검색 조건을 다양하게 할 수 있다.
- 스프링 데이터 JPA에서는 메서드 명에 OrderBy를 넣거나 인자에 `Sort`를 넣음으로써 정렬을 할 수 있다.
- 페이징 처리도 `Pageable`를 통해 쉽게 할 수 있다.
    - 다만 return 타입을 `Page`로 하면 count 쿼리가 같이 날라가니 성능상으로 유의해야 한다.
- 조회용 DTO를 쿼리에 넣어 동적으로 객체를 생성할 수 있다.

### 💡 관련 생각

- 보통 스펙 대신 QueryDsl을 사용해 이를 활용할 생각을 하지 못했다. 다만, 팀 내 컨벤션을 살펴 사용해야 할 것 같다.

---

## Chapter 6. 응용 서비스와 표현 영역

### 💬 간단 정리

- 이 챕터에서는 응용 서비스와 표현 영역이 무슨 역할을 하는지 설명한다.
- 응용 서비스는 사용자가 요청한 기능을 실행하는 역할을 담당한다.
    - 도메인 객체의 기능을 실행하고 도메인 객체 간의 흐름만 제어하기 때문에 단순한 형태를 띈다.
    - 만약 응용 서비스가 복잡하다면, 도메인 로직을 일부 구현하고 있을 것이다.
        - 도메인 로직이 도메인 객체 내에 있으면 코드 중복을 줄이고 유지보수하기가 쉬워진다.
            - 각 응용 서비스에서는 해당 도메인 로직을 호출하면 되기 때문…
    - 응용 서비스는 2가지 방식으로 구현할 수 있다.
        1. 한 클래스에 모든 로직 넣기
            - 장점: 중복된 로직을 private 메서드로 빼기 좋다.
            - 단점: 클래스의 크기가 비대해져 테스트 및 유지보수하기가 힘들어진다.(관련이 없는 메서드도 들어올 수 있다)
        2. 로직 별로 클래스 분리하기
            - 장점: 한 클래스가 하나의 로직만 수행하기 때문에, 코드 품질을 일정 수준으로 유지하기 쉽다.
            - 단점: 클래스가 많아진다.(중복된 로직은 helper 클래스로 분리할 수 있다)
    - 응용 서비스에서는 표현 영역에 의존하면 안된다는 불문율이 있다. 이는 테스트를 어렵게 하고 표현 영역의 변경을 어렵게 하기 때문이다.
    - 응용 서비스는 다음 역할들을 담당한다.
        - 트랜잭션 처리
        - 접근제어
        - 이벤트 처리
- 표현 영역은 사용자 요청을 해석하는 역할을 담당한다.
    - 표현 영역의 책임은 다음 3가지이다.
        1. *사용자가 시스템을 사용할 수 있는 흐름(화면)을 제공하고 제어한다.*
        2. *사용자의 요청을 알맞은 응용 서비스에 전달하고 결과를 사용자에게 제공한다.*
        3. *사용자의 세션을 관리한다.*
- 값 검증과 권한 검증은 표현영역 및 응용 서비스 모두에서 할 수 있다.
    - 값 검증의 경우 개인의 취향에 따라 필수 값 및 형식 등을 표현 영역에서 진행하고, 응용 서비스에서 데이터의 존재 유무만 판단하는 방식으로 진행할 수 있다.
        - 다만, 책의 글쓴이는 응용 서비스의 완성도를 위해 응용 서비스에서 모든 검증을 수행한다고 한다.
    - 권한 검사는 표현영역과 응용 서비스에서 뿐만 아니라 도메인 영역에서도 수행될 수 있다.
        - 표현 영역에서 인증 등을 처리하고, AOP를 이용해서 인가를 응용 서비스 영역에 처리하는 등 다양한 영역에서 수행된다.
        - 도메인 영역의 경우는 글을 수정할 수 있는 권한을 체크하는 등 개별 도메인 수준의 권한 체크를 할 때 권한 검사 로직을 구현해야 한다.

### 💡 관련 생각

- 책을 읽으면서 막연하게 더 좋은 것 같다는 방식에 대해 확신을 얻게 되는 것 같다.
    - 예를 들어, 로직 별로 클래스를 분리하는 것도 실제 개발을 하다보면 한 클래스에 너무 많은 메서드가 있어 테스트하기도 어렵고 재사용하기도 어려운 것을 느꼈다.
        - 그래서 요즘에는 최대한 하나의 클래스에서는 하나의 역할만 수행하도록 하고 있다.
    - 추가로, 응용 서비스에서 로직을 수행할지 도메인 서비스에서 로직을 수행할지에 대한 고민이 항상 존재했다.
        - 스프링 빈이 필요한 로직이라거나 외부 의존성이 필요한 로직의 경우는 어떻게 할지에 대한 고민이 아직 남아있다.

---

## 📌 정리 및 느낀 점

- 4, 5장은 대체적으로 DDD를 하기 위한 JPA의 기능들을 소개한 챕터라 제대로 집중이 되지 않았다.
    - 새로운 기술도 많이 알게 되었지만, 실무에서 이정도로 딥하게 사용하는 곳이 있을까 하는 생각이 들었고, 한편으로는 그런 곳으로 가보고 싶다는 생각이 들었다.
- 6장에서는 기존에 고민하고 있던 것들이 주제로 나와 집중력있게 읽을 수 있었던 것 같다.

---
